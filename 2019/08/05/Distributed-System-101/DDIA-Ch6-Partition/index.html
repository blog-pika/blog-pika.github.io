<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">

  <!-- PACE Progress Bar START -->
  
    <script src="https://raw.githubusercontent.com/HubSpot/pace/v1.0.2/pace.min.js"></script>
    <link rel="stylesheet" href="https://github.com/HubSpot/pace/raw/master/themes/orange/pace-theme-flash.css">
  
  

  <!-- PACE Progress Bar START -->

  
  <title>ddia - ch6 - partition | The Code and Sixpence</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  <meta name="keywords" content="Distributed SystemDDIAPartition">
  
  
  
  
  <meta name="description" content="AbstractThis blog is my reading notes for Designing Data-Intensive Applications, Chapter 06: Partition. Partitioning means splitting a large dataset into smaller subsets, which are then placed on diff">
<meta name="keywords" content="Distributed System,DDIA,Partition">
<meta property="og:type" content="article">
<meta property="og:title" content="DDIA - Ch6 - Partition">
<meta property="og:url" content="https://blog-pika.github.io/2019/08/05/Distributed-System-101/DDIA-Ch6-Partition/index.html">
<meta property="og:site_name" content="The Code and Sixpence">
<meta property="og:description" content="AbstractThis blog is my reading notes for Designing Data-Intensive Applications, Chapter 06: Partition. Partitioning means splitting a large dataset into smaller subsets, which are then placed on diff">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2019-08-09T03:01:42.849Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="DDIA - Ch6 - Partition">
<meta name="twitter:description" content="AbstractThis blog is my reading notes for Designing Data-Intensive Applications, Chapter 06: Partition. Partitioning means splitting a large dataset into smaller subsets, which are then placed on diff">
  
    <link rel="alternate" href="/atom.xml" title="The Code and Sixpence" type="application/atom+xml">
  
  <link rel="icon" href="/css/images/favicon.ico">
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link href="https://fonts.googleapis.com/css?family=Open+Sans|Montserrat:700" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic" rel="stylesheet" type="text/css">
  <link href="https://cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
  <style type="text/css">
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/9749f0/00000000000000000001008f/27/l?subset_id=2&fvd=n5) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/90cf9f/000000000000000000010091/27/l?subset_id=2&fvd=n7) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/8a5494/000000000000000000013365/27/l?subset_id=2&fvd=n4) format("woff2");font-weight:lighter;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/d337d8/000000000000000000010095/27/l?subset_id=2&fvd=i4) format("woff2");font-weight:400;font-style:italic;}</style>
    
  <link rel="stylesheet" id="athemes-headings-fonts-css" href="//fonts.googleapis.com/css?family=Yanone+Kaffeesatz%3A200%2C300%2C400%2C700&amp;ver=4.6.1" type="text/css" media="all">
  <link rel="stylesheet" href="/css/style.css">

  <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>

  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/bootstrap/3.0.2/css/bootstrap.min.css">
  <link rel="stylesheet" href="/css/hiero.css">
  <link rel="stylesheet" href="/css/glyphs.css">
  

  <!-- Custom CSS -->
  <link rel="stylesheet" href="/css/my.css">
  <!-- Google Adsense -->
  
</head>
</html>
<script>
var themeMenus = {};

  themeMenus["/"] = "Home"; 

  themeMenus["/archives"] = "Archives"; 

  themeMenus["/categories"] = "Categories"; 

  themeMenus["/tags"] = "Tags"; 

  themeMenus["/about"] = "About"; 

</script>


  <body data-spy="scroll" data-target="#toc" data-offset="50">


  <header id="allheader" class="site-header" role="banner">
  <div class="clearfix container">
      <div class="site-branding">

          <h1 class="site-title">
            
              <a href="/" title="The Code and Sixpence" rel="home"> The Code and Sixpence </a>
            
          </h1>

          
            
          <nav id="main-navigation" class="main-navigation" role="navigation">
            <a class="nav-open">Menu</a>
            <a class="nav-close">Close</a>
            <div class="clearfix sf-menu">

              <ul id="main-nav" class="nmenu sf-js-enabled">
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/">Home</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/archives">Archives</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/categories">Categories</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/tags">Tags</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/about">About</a> </li>
                    
              </ul>
            </div>
          </nav>


      </div>
  </div>
</header>


  <div id="originBgDiv" style="background: #fff; width: 100%;">

      <div style="max-height:600px; overflow: hidden;  display: flex; display: -webkit-flex; align-items: center;">
        <img id="originBg" width="100%" alt="" src="">
      </div>

  </div>

  <script>
  function setAboutIMG(){
      var imgUrls = "css/images/pose.jpg,https://source.unsplash.com/collection/954550/1920x1080".split(",");
      var random = Math.floor((Math.random() * imgUrls.length ));
      if (imgUrls[random].startsWith('http') || imgUrls[random].indexOf('://') >= 0) {
        document.getElementById("originBg").src=imgUrls[random];
      } else {
        document.getElementById("originBg").src='/' + imgUrls[random];
      }
  }
  bgDiv=document.getElementById("originBgDiv");
  if(location.pathname.match('about')){
    setAboutIMG();
    bgDiv.style.display='block';
  }else{
    bgDiv.style.display='none';
  }
  </script>



  <div id="container">
    <div id="wrap">
            
      <div id="content" class="outer">
        
          <section id="main" style="float:none;"><article id="post-Distributed-System-101/DDIA-Ch6-Partition" style="width: 66%; float:left;" class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" class="article-title" itemprop="name">
      DDIA - Ch6 - Partition
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	Posted on <a href="/2019/08/05/Distributed-System-101/DDIA-Ch6-Partition/" class="article-date">
	  <time datetime="2019-08-05T07:00:00.000Z" itemprop="datePublished">August 5, 2019</time>
	</a>

      
	<span id="busuanzi_container_page_pv">
	  本文总阅读量<span id="busuanzi_value_page_pv"></span>次
	</span>

    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Abstract"><a href="#Abstract" class="headerlink" title="Abstract"></a>Abstract</h2><p>This blog is my reading notes for <em>Designing Data-Intensive Applications</em>, Chapter 06: Partition.</p>
<p><code>Partitioning</code> means splitting a large dataset into smaller subsets, which are then placed on different nodes in a shared-nothing cluster. It is necessary when you have so much data that storing and processing it on a single machine is no longer feasible. Also it has advantages over <strong>scalability</strong>: a large dataset can be distributed across many disks, and the query load can be distributed across many processors.</p>
<a id="more"></a>

<p>In this blog we will look at the following topics one by one:</p>
<ul>
<li>How to partition datasets and avoid hot spot?</li>
<li>How to rebalance Data?</li>
<li>How to use secondary indexes in partition?</li>
<li>How to route request?</li>
</ul>
<h2 id="Approaches-to-Partitioning"><a href="#Approaches-to-Partitioning" class="headerlink" title="Approaches to Partitioning"></a>Approaches to Partitioning</h2><p>We have following ways of partition:</p>
<ul>
<li><code>Key Range Partition</code>: assign a continuous range of keys to each partition. Within each partition, keys are kept in sorted order. The advantage is that efficient range queries are possible, but there is a risk of hot spots if the application often accesses keys that are close together in the sorted order. Partitions are typically rebalanced dynamically by splitting the range into two sub-ranges when a partition gets too big.</li>
<li><code>Hash Partition</code>: a hash function is applied to each key, and a partition owns a range of hashes. Range queries are inefficient, but data are distributed more evenly. When partitioning by hash, it is common to create a fixed number of partitions in advance, to assign several partitions to each node, and to move partitions from one node to another when nodes are added or removed. Dynamic partitioning can also be used.</li>
<li><code>Hybrid Partition</code>: a table can be declared with a compound primary key consisting of several columns. Only the first part of that key is hashed to determine the partition, but the other columns are used as a concatenated index for sorting the data. This approach enables an elegant data model for one-to-many relationships. For example, on a social media site, one user may post many updates. If the primary key for updates is chosen to be (user_id, update_timestamp), then you can efficiently retrieve all updates made by a particular user within some time interval, sorted by timestamp.</li>
</ul>
<p>If the partitioning is unfair, so that some partitions have more data or queries than others, we call it skewed. A partition with disproportionately high load is called a <code>hot spot</code>. Today, most data systems are not able to automatically compensate for such a highly skewed workload, so it’s the responsibility of the application to reduce the skew.</p>
<p>One simple technique is that, if one key is known to be very hot, add a random number to the beginning or end of the key can split the writes to the key evenly across different keys, i.e., distributed to different partitions. The disadvantage is that this technique now requires additional bookkeeping and reading the data now need to query from all keys and combine them.</p>
<h2 id="Rebalancing"><a href="#Rebalancing" class="headerlink" title="Rebalancing"></a>Rebalancing</h2><p><code>Rebalancing</code> is the process of moving load from one node in the cluster to another, which is called for the following changes: query throughput increases, dataset size increases, node fails. Usually it is expected to meet some minimum requirements:</p>
<ul>
<li>After rebalancing, the load should be shared fairly between the nodes in the cluster.</li>
<li>While rebalancing is happening, the database should continue accepting reads and writes.</li>
<li>No more data than necessary should be moved between nodes, to make rebalancing fast and to minimize the network and disk I/O load.</li>
</ul>
<p>We also have 3 approaches to do that:</p>
<ul>
<li><code>Fixed number of partitions</code>: can be used if the dataset is not highly variable: create many more partitions than there are nodes, and assign several partitions to each node. If a node is added to the cluster, the new node can steal a few partitions from every existing node until partitions are fairly distributed once again. In this partition, the number of partitions is usually fixed when the database is first set up and not changed afterward. Also, partition splitting is usually not implemented. <strong>The number of partitions configured at the outset = the maximum number of nodes * number of partitions per node</strong>, so you need to choose it high enough to accommodate future growth. Used in <strong>Riak</strong>, <strong>Elasticsearch</strong>, <strong>Couchbase</strong>, and <strong>Voldemort</strong></li>
<li><code>Dynamic partitioning proportional to the size of the dataset</code>: When a partition grows to exceed a configured size, it is split into two partitions so that approximately half of the data ends up on each side of the split. Conversely, if lots of data is deleted and a partition shrinks below some threshold, it can be merged with an adjacent partition. In the initial state when the dataset is small or empty, an initial set of partitions to be configured. Used by <strong>HBase</strong> and <strong>MongoDB</strong></li>
<li><code>Dynamic partitioning proportional to the number of nodes</code>: When a new node joins the cluster, it randomly chooses a fixed number of existing partitions to split, and then takes ownership of one half of each of those split partitions while leaving the other half of each partition in place. The randomization can produce unfair splits, but when averaged over a larger number of partitions, the new node ends up taking a fair share of the load from the existing nodes. Used in Cassandra and Ketama.</li>
</ul>
<p>Fully automated rebalancing can be convenient but unpredictable. Rebalancing is an expensive operation, if it is not done carefully, this process can overload the network or the nodes and harm the performance of other requests while the rebalancing is in progress. In combination with automatic failure detection, other nodes can conclude an overloaded node to be dead and automatically rebalance the cluster to move load away from it, which may cause a cascading failure.</p>
<h2 id="Secondary-index"><a href="#Secondary-index" class="headerlink" title="Secondary index"></a>Secondary index</h2><p>since dataset is partitioned by primary key, secondary indexes don’t map neatly to partitions. Thus, many key-value stores have avoided secondary indexes because of their added implementation complexity, but some have started adding them because they are so useful for data modeling. There are two methods:</p>
<ul>
<li><p><code>Document-partitioned indexes</code>: each partition is completely separate and maintains its own <strong>local secondary indexes</strong>, covering only the documents in that partition. This means that only a single partition needs to be updated on write, but a read of the secondary index requires a scatter/gather across all partitions, which is expensive.</p>
</li>
<li><p><code>Term-partitioned indexes</code>: construct a <strong>global secondary index</strong> that covers data in all partitions. The global index is also partitioned to avoid bottleneck, but it can be partitioned differently from the primary key index. When a document is written, a distributed transaction across all partitions that need to be updated is required, which is expensive. However, a read can be served from a single partition and is efficient.</p>
</li>
</ul>
<h2 id="Request-Routing"><a href="#Request-Routing" class="headerlink" title="Request Routing"></a>Request Routing</h2><p>When a client wants to make a request, how does it know <strong>which node to connect to</strong>? On a high level, there are a few different approaches to this problem.</p>
<ul>
<li>Allow clients to contact any node. If that node does not own the partition, it forwards the request to the appropriate node</li>
<li>Send all requests from clients to a routing tier first, which determines the node that should handle each request and forwards it accordingly. This routing tier does not itself handle any requests; it only acts as a partition-aware load balancer.</li>
<li>Require that clients be aware of the partitioning and the assignment of partitions to nodes, thus they can connect directly to the appropriate node without any intermediary.</li>
</ul>
<p>In all cases, the key problem is: <strong>how does the component making the routing decision and learn about changes in the assignment of partitions to nodes</strong>? This is an instance of a more general problem called <code>service discovery</code> Any piece of software that is accessible over a network has this problem, especially if it is aiming for high availability.</p>
<p>Many distributed data systems rely on a separate <code>coordination service</code> such as ZooKeeper to keep track of this cluster metadata. Each node registers itself in ZooKeeper, and ZooKeeper maintains the authoritative mapping of partitions to nodes. Other actors, such as the routing tier or the partitioning-aware client, can subscribe to this information in ZooKeeper. Whenever a partition changes ownership, or a node is added or removed, ZooKeeper notifies the routing tier so that it can keep its routing information up to date.</p>
<p>Or the system can use a <code>gossip protocol</code> among the nodes to disseminate any changes in cluster state. Requests can be sent to any node, and that node forwards them to the appropriate node for the requested partition. Cassandra and Riak adopt this way.</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><blockquote>
<p>[1] <em>Designing Data-Intensive Applications</em>, Chapter 06: Partition</p>
</blockquote>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/Reading-Notes/">Reading Notes</a>, <a class="article-category-link" href="/categories/Reading-Notes/Designing-Data-Intensive-Applications/">Designing Data-Intensive Applications</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/DDIA/">DDIA</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Distributed-System/">Distributed System</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Partition/">Partition</a></li></ul>

      
            
      
        
	<section id="comments" class="comment">
	  <div id="disqus_thread">
	  <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
	  </div>
	</section>

	<script type="text/javascript">
	var disqus_shortname = 'https-blog-pika-github-io';
	(function(){
	  var dsq = document.createElement('script');
	  dsq.type = 'text/javascript';
	  dsq.async = true;
	  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
	  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	}());
	(function(){
	  var dsq = document.createElement('script');
	  dsq.type = 'text/javascript';
	  dsq.async = true;
	  dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
	  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	}());
	</script>


      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2019/08/11/Distributed-System-101/DDIA-Ch8-Pitfalls-in-distribuetd-system/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          DDIA - Ch8 - Pitfalls in Distributed System
        
      </div>
    </a>
  
  
    <a href="/2019/08/01/Distributed-System-101/DDIA-Ch5-Replicattion/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">DDIA - Ch5 - Replication</div>
    </a>
  
</nav>

  
</article>

<!-- Table of Contents -->

  <aside id="sidebar">
    <div id="toc" class="toc-article" style="overflow-y: scroll; max-width: 28%;">
    <strong class="toc-title">Contents</strong>
    
      <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Abstract"><span class="nav-number">1.</span> <span class="nav-text">Abstract</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Approaches-to-Partitioning"><span class="nav-number">2.</span> <span class="nav-text">Approaches to Partitioning</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Rebalancing"><span class="nav-number">3.</span> <span class="nav-text">Rebalancing</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Secondary-index"><span class="nav-number">4.</span> <span class="nav-text">Secondary index</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Request-Routing"><span class="nav-number">5.</span> <span class="nav-text">Request Routing</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Reference"><span class="nav-number">6.</span> <span class="nav-text">Reference</span></a></li></ol>
    
    </div>
  </aside>
</section>
        
      </div>
      <footer id="footer" class="site-footer">
  

  <div class="clearfix container">
      <div class="site-info">
	      &copy; 2019 The Code and Sixpence All Rights Reserved.
          
            <span id="busuanzi_container_site_uv">
              本站访客数<span id="busuanzi_value_site_uv"></span>人次  
              本站总访问量<span id="busuanzi_value_site_pv"></span>次
            </span>
          
      </div>
      <div class="site-credit">
        Theme by <a href="https://github.com/iTimeTraveler/hexo-theme-hiero" target="_blank">hiero</a>
      </div>
  </div>
</footer>


<!-- min height -->

<script>
    var contentdiv = document.getElementById("content");

    contentdiv.style.minHeight = document.body.offsetHeight - document.getElementById("allheader").offsetHeight - document.getElementById("footer").offsetHeight + "px";
</script>

<!-- Custome JS -->
<script src="/js/my.js"></script>
    </div>
    <!-- <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/categories" class="mobile-nav-link">Categories</a>
  
    <a href="/tags" class="mobile-nav-link">Tags</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav> -->
    

<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>



  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.5/jquery.fancybox.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.5/jquery.fancybox.min.js"></script>


<script src="/js/scripts.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>


<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'true', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->







	<script async src="https://dnqof95d40fo6.cloudfront.net/atw7f8.js">
	</script>





<!-- Tencent Analytics -->
	<script type="text/javascript">
    (function() {
      var hm = document.createElement("script");
      hm.src = "//tajs.qq.com/stats?sId={{ theme.tencent_analytics }}";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>
<!-- End Tencent Analytics -->


  </div>

  <a id="rocket" href="#top" class=""></a>
  <script type="text/javascript" src="/js/totop.js" async=""></script>
</body>
</html>
