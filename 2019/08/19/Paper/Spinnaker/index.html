<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">

  <!-- PACE Progress Bar START -->
  
    <script src="https://raw.githubusercontent.com/HubSpot/pace/v1.0.2/pace.min.js"></script>
    <link rel="stylesheet" href="https://github.com/HubSpot/pace/raw/master/themes/orange/pace-theme-flash.css">
  
  

  <!-- PACE Progress Bar START -->

  
  <title>spinnaker | The Code and Sixpence</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  <meta name="keywords" content="Paxos">
  
  
  
  
  <meta name="description" content="This blog is my reading notes for Spinnaker. We can learn from this paper how to use consensus algorithm (Paxos) to do replication in database.">
<meta name="keywords" content="Paxos">
<meta property="og:type" content="article">
<meta property="og:title" content="Spinnaker">
<meta property="og:url" content="https://blog-pika.github.io/2019/08/19/Paper/Spinnaker/index.html">
<meta property="og:site_name" content="The Code and Sixpence">
<meta property="og:description" content="This blog is my reading notes for Spinnaker. We can learn from this paper how to use consensus algorithm (Paxos) to do replication in database.">
<meta property="og:locale" content="default">
<meta property="og:image" content="https://blog-pika.github.io/images/Spinnaker/A-Spinnaker-Cluster.png">
<meta property="og:image" content="https://blog-pika.github.io/images/Spinnaker/The-replication-protocol.png">
<meta property="og:updated_time" content="2019-08-20T04:28:32.025Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Spinnaker">
<meta name="twitter:description" content="This blog is my reading notes for Spinnaker. We can learn from this paper how to use consensus algorithm (Paxos) to do replication in database.">
<meta name="twitter:image" content="https://blog-pika.github.io/images/Spinnaker/A-Spinnaker-Cluster.png">
  
    <link rel="alternate" href="/atom.xml" title="The Code and Sixpence" type="application/atom+xml">
  
  <link rel="icon" href="/css/images/favicon.ico">
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link href="https://fonts.googleapis.com/css?family=Open+Sans|Montserrat:700" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic" rel="stylesheet" type="text/css">
  <link href="https://cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
  <style type="text/css">
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/9749f0/00000000000000000001008f/27/l?subset_id=2&fvd=n5) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/90cf9f/000000000000000000010091/27/l?subset_id=2&fvd=n7) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/8a5494/000000000000000000013365/27/l?subset_id=2&fvd=n4) format("woff2");font-weight:lighter;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/d337d8/000000000000000000010095/27/l?subset_id=2&fvd=i4) format("woff2");font-weight:400;font-style:italic;}</style>
    
  <link rel="stylesheet" id="athemes-headings-fonts-css" href="//fonts.googleapis.com/css?family=Yanone+Kaffeesatz%3A200%2C300%2C400%2C700&amp;ver=4.6.1" type="text/css" media="all">
  <link rel="stylesheet" href="/css/style.css">

  <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>

  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/bootstrap/3.0.2/css/bootstrap.min.css">
  <link rel="stylesheet" href="/css/hiero.css">
  <link rel="stylesheet" href="/css/glyphs.css">
  

  <!-- Custom CSS -->
  <link rel="stylesheet" href="/css/my.css">
  <!-- Google Adsense -->
  
</head>
</html>
<script>
var themeMenus = {};

  themeMenus["/"] = "Home"; 

  themeMenus["/archives"] = "Archives"; 

  themeMenus["/categories"] = "Categories"; 

  themeMenus["/tags"] = "Tags"; 

  themeMenus["/about"] = "About"; 

</script>


  <body data-spy="scroll" data-target="#toc" data-offset="50">


  <header id="allheader" class="site-header" role="banner">
  <div class="clearfix container">
      <div class="site-branding">

          <h1 class="site-title">
            
              <a href="/" title="The Code and Sixpence" rel="home"> The Code and Sixpence </a>
            
          </h1>

          
            
          <nav id="main-navigation" class="main-navigation" role="navigation">
            <a class="nav-open">Menu</a>
            <a class="nav-close">Close</a>
            <div class="clearfix sf-menu">

              <ul id="main-nav" class="nmenu sf-js-enabled">
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/">Home</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/archives">Archives</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/categories">Categories</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/tags">Tags</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/about">About</a> </li>
                    
              </ul>
            </div>
          </nav>


      </div>
  </div>
</header>


  <div id="originBgDiv" style="background: #fff; width: 100%;">

      <div style="max-height:600px; overflow: hidden;  display: flex; display: -webkit-flex; align-items: center;">
        <img id="originBg" width="100%" alt="" src="">
      </div>

  </div>

  <script>
  function setAboutIMG(){
      var imgUrls = "css/images/pose.jpg,https://source.unsplash.com/collection/954550/1920x1080".split(",");
      var random = Math.floor((Math.random() * imgUrls.length ));
      if (imgUrls[random].startsWith('http') || imgUrls[random].indexOf('://') >= 0) {
        document.getElementById("originBg").src=imgUrls[random];
      } else {
        document.getElementById("originBg").src='/' + imgUrls[random];
      }
  }
  bgDiv=document.getElementById("originBgDiv");
  if(location.pathname.match('about')){
    setAboutIMG();
    bgDiv.style.display='block';
  }else{
    bgDiv.style.display='none';
  }
  </script>



  <div id="container">
    <div id="wrap">
            
      <div id="content" class="outer">
        
          <section id="main" style="float:none;"><article id="post-Paper/Spinnaker" style="width: 66%; float:left;" class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" class="article-title" itemprop="name">
      Spinnaker
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	Posted on <a href="/2019/08/19/Paper/Spinnaker/" class="article-date">
	  <time datetime="2019-08-20T03:12:09.000Z" itemprop="datePublished">August 19, 2019</time>
	</a>

      
	<span id="busuanzi_container_page_pv">
	  本文总阅读量<span id="busuanzi_value_page_pv"></span>次
	</span>

    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>This blog is my reading notes for Spinnaker. We can learn from this paper how to use consensus algorithm (Paxos) to do replication in database.</p>
<a id="more"></a>

<h2 id="Pros"><a href="#Pros" class="headerlink" title="Pros"></a>Pros</h2><p>Spinnaker features key-based range partitioning, 3-way replication, and a transactional get-put API with the option to choose either strong or timeline consistency on reads. Spinnaker will be available for reads and writes as long a majority of its replicas are alive.  The performance can be competitive with alternatives that provide weaker consistency guarantees. Compared to an eventually consistent datastore, Spinnaker can be as fast or even faster on reads and only 5% to 10% slower on writes.</p>
<h2 id="Cons"><a href="#Cons" class="headerlink" title="Cons"></a>Cons</h2><p>Only suitable in single datacenter and cannot tolerate network partition</p>
<h2 id="Data-Model-and-API"><a href="#Data-Model-and-API" class="headerlink" title="Data Model and API"></a>Data Model and API</h2><p>Data Model is almost the same as BigTable. Besides, each API call is executed as a single-operation transaction.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">get(key, colname, consistent)</span><br><span class="line"><span class="comment">// Read a column value and its version number from a row. The setting of the ‘consistent’ ﬂag is used to choose the consistency level. Setting it to ‘true’ chooses strong consistency, and the latest value is always returned. Setting it to ‘false’ chooses timeline consistency, and a possibly stale value is returned in exchange for better performance.</span></span><br><span class="line"></span><br><span class="line">put(key, colname, colvalue)</span><br><span class="line"><span class="comment">// Insert a column value into a row.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">delete</span>(key, colname)</span><br><span class="line"><span class="comment">// Delete a column from a row.</span></span><br><span class="line"></span><br><span class="line">conditionalPut(key, colname, value, v)</span><br><span class="line"><span class="comment">// Insert a new column value into a row only if the column’s current version number is equal to ‘v’. Otherwise, an error is returned.</span></span><br><span class="line"></span><br><span class="line">conditionalDelete(key, colname, v)</span><br><span class="line"><span class="comment">//Like conditional put but for delete.</span></span><br></pre></td></tr></table></figure>

<h2 id="Architecture"><a href="#Architecture" class="headerlink" title="Architecture"></a>Architecture</h2><p>The architecture of Spinnaker is also similar to BigTable. However, they use different ways to make logs and data fault-tolerant:</p>
<ul>
<li>BigTable: store data and logs on GFS</li>
<li>Spinnaker: use <code>Paxos</code> to replicate logs to multiple nodes</li>
</ul>
<h3 id="Replication"><a href="#Replication" class="headerlink" title="Replication"></a>Replication</h3><p>Like Bigtable, Spinnaker distributes the rows of a table across its cluster using range partitioning. Each node is assigned a base key range, which is replicated on the next N − 1 nodes. Each group of nodes involved in replicating a key range is denoted as a cohort. Figure below shows a Spinnaker cluster with 5 nodes and N = 3.</p>
<p><img src="/images/Spinnaker/A-Spinnaker-Cluster.png" alt="Example of a Spinnaker cluster"></p>
<p>Each cohort has an elected leader, with the other 2 nodes acting as followers. The replication protocol has two phases: a <code>leader election phase</code>, followed by a <code>quorum phase</code> where the leader proposes a write and the followers accept it.</p>
<p><img src="/images/Spinnaker/The-replication-protocol.png" alt="The replication protocol"></p>
<p>The steps of Spinnaker’s replication protocol in steady state are as follow:</p>
<ol>
<li>When a client submits a write W, it always gets routed to the leader of the affected key range</li>
<li>The leader appends a log record for W to its log and then initiates a log force to disk</li>
<li>The leader appends W to its commit queue and sends a propose message for W to its followers</li>
<li>When the followers receive the propose message, they force a log record for W to disk, append W to their commit queue, and reply with an ack to the leader</li>
<li>After the leader gets an ack from the majority, it applies W to its memtable, effectively committing W</li>
<li>The leader returns a response to the client. </li>
</ol>
<p>Periodically, the leader sends an asynchronous commit message to the followers asking them to apply all pending writes up to a certain LSN to their memtable.</p>
<p>Strongly consistent reads are always routed to the cohort’s leader, so they are guaranteed to see the latest value for W. Timeline consistent reads can be routed to any node in the cohort, so they may see a stale value for W until its commit message is processed</p>
<h3 id="Recovery"><a href="#Recovery" class="headerlink" title="Recovery"></a>Recovery</h3><p>Let f.cmt = follower’s last committed LSN and f.lst = the follower’s last LSN in its log.</p>
<p>The recovery of a follower proceeds in two phases:</p>
<p><code>local recovery</code>: simply replay log between snapshot and f.cmt to recover the memtable<br><code>catch up</code>: the logs between f.cmt and f.lst may or may not have been committed by the leader, so the follower has to consult the leader</p>
<p>The recovery of leader consists of re-election. The new leader may be not up-to-date, so it need to truncate the logs. However, since different key ranges write to the same log file (same as BigTable), Spinnaker uses skip-list to do logical truncation. </p>
<h2 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h2><p>The lecture of MIT has FAQ: <a href="https://pdos.csail.mit.edu/6.824/papers/spinnaker-faq.txt" target="_blank" rel="noopener">Spinnaker FAQ</a></p>
<blockquote>
<p>Q: What is a shared write-ahead log?</p>
</blockquote>
<p>A: Same as BigTable, one node only has one log file to improve performance. Different key ranges write to the same log file.</p>
<blockquote>
<p>Q: Periodically, the leader in Spinnaker sends an asynchronous commit message to the followers. Is this design better than sending the commit message as soon as the leader commits the log?</p>
</blockquote>
<blockquote>
<p>Q: The paper says “A conditional put is guaranteed to have the same outcome on each node of the cohort because writes are executed in LSN order within a cohort.” If using normal put, will the writes be applied out of order?</p>
</blockquote>
<blockquote>
<p>Q: The paper says: “At the end of the catch up phase, the leader momentarily blocks new writes to ensure that that the follower is fully caught up.” I don’t think blocking the writes is necessary.</p>
</blockquote>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ol>
<li><a href="https://pdos.csail.mit.edu/6.824/papers/spinnaker.pdf" target="_blank" rel="noopener">Using Paxos to Build a Scalable, Consistent, and Highly Available Datastore</a>  </li>
<li><a href="https://pdos.csail.mit.edu/6.824/schedule.html" target="_blank" rel="noopener">6.824 Schedule: Spring 2018</a></li>
</ol>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/Paper/">Paper</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Paxos/">Paxos</a></li></ul>

      
            
      
        
	<section id="comments" class="comment">
	  <div id="disqus_thread">
	  <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
	  </div>
	</section>

	<script type="text/javascript">
	var disqus_shortname = 'disqus_t7ZVi0Vi0o';
	(function(){
	  var dsq = document.createElement('script');
	  dsq.type = 'text/javascript';
	  dsq.async = true;
	  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
	  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	}());
	(function(){
	  var dsq = document.createElement('script');
	  dsq.type = 'text/javascript';
	  dsq.async = true;
	  dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
	  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	}());
	</script>


      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2019/08/21/Paper/Zookeeper/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Zookeeper
        
      </div>
    </a>
  
  
    <a href="/2019/08/19/Distributed-System-101/Consistency-Level/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Consistency Level</div>
    </a>
  
</nav>

  
</article>

<!-- Table of Contents -->

  <aside id="sidebar">
    <div id="toc" class="toc-article" style="overflow-y: scroll; max-width: 28%;">
    <strong class="toc-title">Contents</strong>
    
      <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Pros"><span class="nav-number">1.</span> <span class="nav-text">Pros</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Cons"><span class="nav-number">2.</span> <span class="nav-text">Cons</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Data-Model-and-API"><span class="nav-number">3.</span> <span class="nav-text">Data Model and API</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Architecture"><span class="nav-number">4.</span> <span class="nav-text">Architecture</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Replication"><span class="nav-number">4.1.</span> <span class="nav-text">Replication</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Recovery"><span class="nav-number">4.2.</span> <span class="nav-text">Recovery</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#FAQ"><span class="nav-number">5.</span> <span class="nav-text">FAQ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Reference"><span class="nav-number">6.</span> <span class="nav-text">Reference</span></a></li></ol>
    
    </div>
  </aside>
</section>
        
      </div>
      <footer id="footer" class="site-footer">
  

  <div class="clearfix container">
      <div class="site-info">
	      &copy; 2019 The Code and Sixpence All Rights Reserved.
          
            <span id="busuanzi_container_site_uv">
              本站访客数<span id="busuanzi_value_site_uv"></span>人次  
              本站总访问量<span id="busuanzi_value_site_pv"></span>次
            </span>
          
      </div>
      <div class="site-credit">
        Theme by <a href="https://github.com/iTimeTraveler/hexo-theme-hiero" target="_blank">hiero</a>
      </div>
  </div>
</footer>


<!-- min height -->

<script>
    var contentdiv = document.getElementById("content");

    contentdiv.style.minHeight = document.body.offsetHeight - document.getElementById("allheader").offsetHeight - document.getElementById("footer").offsetHeight + "px";
</script>

<!-- Custome JS -->
<script src="/js/my.js"></script>
    </div>
    <!-- <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/categories" class="mobile-nav-link">Categories</a>
  
    <a href="/tags" class="mobile-nav-link">Tags</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav> -->
    

<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>



  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.5/jquery.fancybox.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.5/jquery.fancybox.min.js"></script>


<script src="/js/scripts.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>


<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'true', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->







	<script async src="https://dnqof95d40fo6.cloudfront.net/atw7f8.js">
	</script>





<!-- Tencent Analytics -->
	<script type="text/javascript">
    (function() {
      var hm = document.createElement("script");
      hm.src = "//tajs.qq.com/stats?sId={{ theme.tencent_analytics }}";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>
<!-- End Tencent Analytics -->


  </div>

  <a id="rocket" href="#top" class=""></a>
  <script type="text/javascript" src="/js/totop.js" async=""></script>
</body>
</html>
